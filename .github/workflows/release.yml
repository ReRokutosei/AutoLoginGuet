name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc
          override: true

      - name: Install Inno Setup
        run: |
          curl -OL https://files.jrsoftware.org/is/6/innosetup-6.5.0.exe
          .\innosetup-6.5.0.exe /VERYSILENT /SUPPRESSMSGBOXES /NORESTART
          "C:\Program Files (x86)\Inno Setup 6" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Update version in Inno Setup script
        run: |
          # 从Cargo.toml中提取版本号
          $CARGO_VERSION = Select-String -Path Cargo.toml -Pattern '^version = "(.+)"' | ForEach-Object { $_.Matches.Groups[1].Value }
          (Get-Content installer/InnoSetup.iss) -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$CARGO_VERSION`"" | Set-Content installer/InnoSetup.iss
        shell: pwsh

      - name: Build
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Extract changelog for version
        id: changelog
        run: |
          $VERSION = Select-String -Path Cargo.toml -Pattern '^version = "(.+)"' | ForEach-Object { $_.Matches.Groups[1].Value }
          $CLEAN_VERSION = $VERSION -replace '^v', ''
          $CHANGELOG_CONTENT = Get-Content CHANGELOG.md -Raw -Encoding UTF8
          $MAJOR_VERSION = $CLEAN_VERSION -replace '\.(\d+).*', ''
          $PATTERN = "(#{2,3} \[$MAJOR_VERSION\.[\d\.]+\].*?)(?=#{2,3} \[.*\]|\Z)"
          $MATCHES = [regex]::Matches($CHANGELOG_CONTENT, $PATTERN, [System.Text.RegularExpressions.RegexOptions]::Singleline)
          
          if ($MATCHES.Count -gt 0) {
            $CHANGELOG_TEXT = ""
            $limit = [Math]::Min(2, $MATCHES.Count)
            for ($i = 0; $i -lt $limit; $i++) {
              $CHANGELOG_TEXT += $MATCHES[$i].Groups[1].Value.Trim() + "`n`n"
            }
          } else {
            $CHANGELOG_TEXT = "No changelog entry found for major version $MAJOR_VERSION"
          }
          $CHANGELOG_TEXT | Out-File -FilePath "RELEASE_NOTE.md" -Encoding UTF8
        shell: pwsh

      - name: Build Installer
        run: |
          cd installer
          ISCC.exe InnoSetup.iss
        shell: pwsh

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body_path: ./RELEASE_NOTE.md
          files: |
            AutoLoginGUET-*-installer.exe
